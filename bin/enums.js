"use strict"

function main({ schema, output }) {
  const fs = require("fs")
  const utils = require("graphql/utilities")
  const isEnumType = require("graphql/type").isEnumType

  console.info(schema, output)

  const typeMap = utils.buildSchema(fs.readFileSync(schema).toString()).getTypeMap()
  const enums = Object.keys(typeMap)
    .reduce((p, name) => {
      const type = typeMap[name]
      if (!name.startsWith("__") && isEnumType(type)) {
        p.push(
          `export const ${name} = {\n${type
            .getValues()
            .map(e => `  ${e.name}: "${e.name}"`)
            .join(",\n")}\n};`
        )
      }
      return p
    }, [])
    .sort()

  fs.writeFileSync(
    output,
    `/* Generated by running relay-fns/enums /*

/* eslint-disable */
/* prettier-ignore-start */

${enums.join("\n\n")}

/* prettier-ignore-end */`
  )

  console.info(`Updated: ${output}`)
}

const yargs = require("yargs")
const argv = yargs
  .usage("Generate Enums from a schema.graphql file\n\n" + "$0 --schema <path> --output <path>")
  .options({
    schema: {
      array: false,
      type: "string",
      demandOption: true,
      describe: "Path to schema.graphql"
    },
    output: {
      array: false,
      type: "string",
      demandOption: true,
      describe: "Output file"
    }
  })
  .help().argv

main(argv)
